#!/usr/bin/php -q
<?php
include_once "config.php";
include_once "library.php";

set_time_limit (3600);

//echo "Starting Top 20 report generator\n";
$top20=GetTop20Spam();
//echo "Starting last blocked hosts report generator\n";
$lastblocked=GetLastBlockedHosts();
//echo "Starting block list check report generator\n";
$checkblocklist=CheckBlocklists();
//echo "Starting malware log report generator\n";
$malware=CheckLogsForMalware ();
//echo "Starting spam log report generator\n";
$spam=CheckLogsForSpam ();

$query="SELECT * FROM reports order by ReportType";
$rpresult=mysql_query($query);

while($row=mysql_fetch_array($rpresult)){
	$type=$row['ReportType'];

	switch($type){
		case 1: 
			$date=date("d. m. Y");
			$filedate=date("d-m-Y");
			$report="<!DOCTYPE HTML PUBLIC '-//W3C//DTD HTML 4.01 Transitional//EN' 'http://www.w3c.org/TR/1999/REC-html401-19991224/loose.dtd'><HTML><HEAD><TITLE>Mailserver Report vom ".$date."</TITLE>\r<STYLE type=text/css>\rA.Stil1:hover {COLOR: #808080; TEXT-DECORATION: underline}\rA.Stil2:hover {COLOR: #0064e6; TEXT-DECORATION: underline}\rA.Stil3:hover {COLOR: #fd7112; TEXT-DECORATION: underline}\rA.Stil5:hover {COLOR: black; TEXT-DECORATION: underline\r}A.Stil8:hover {COLOR: #0064e6; TEXT-DECORATION: underline}\rA.Stil12:hover {COLOR: #0064e6; TEXT-DECORATION: underline}\r.Stil1 {FONT-SIZE: 9px; COLOR: #808080; FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif; TEXT-DECORATION: none}\r.Stil2 {FONT-WEIGHT: bold; FONT-SIZE: 12px; COLOR: #0064e6; FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif; TEXT-DECORATION: none}\r.Stil3 {FONT-SIZE: 11px; COLOR: #fd7112; FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif; TEXT-DECORATION: none}\r.Stil4 {FONT-SIZE: 11px; FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif}\r.Stil7 {FONT-WEIGHT: bold; FONT-SIZE: 14px; COLOR: #fd7112; FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif}\r.Stil8 {FONT-WEIGHT: bold; FONT-SIZE: 11px; COLOR: #0064e6; FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif; TEXT-DECORATION: none}\r.Stil9 {FONT-WEIGHT: bold; FONT-SIZE: 9px; COLOR: black; FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif; TEXT-DECORATION: none}\r.Stil10 {FONT-WEIGHT: bold; FONT-SIZE: 14px; COLOR: black; FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif}\r.Stil11 {FONT-SIZE: 9px; COLOR: black; FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif; TEXT-DECORATION: none}\r.Stil12 {FONT-WEIGHT: bold; FONT-SIZE: 9px; COLOR: #0064e6; FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif; TEXT-DECORATION: none}\r.Stil14 {FONT-WEIGHT: bold; FONT-SIZE: 11px; COLOR: #fd7112; FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif}\r.Stil15 {FONT-SIZE: 12px; COLOR: #0064e6; FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif; TEXT-DECORATION: none}\rP.MsoNormal {FONT-SIZE: 12pt; MARGIN: 0cm 0cm 0pt; FONT-FAMILY: 'Times New Roman';mso-style-parent: ''; mso-pagination: widow-orphan; mso-fareast-font-family: 'Times New Roman'
}\rLI.MsoNormal {FONT-SIZE: 12pt; MARGIN: 0cm 0cm 0pt; FONT-FAMILY: 'Times New Roman'; mso-style-parent: ''; mso-pagination: widow-orphan; mso-fareast-font-family: 'Times New Roman'}\rDIV.MsoNormal {FONT-SIZE: 12pt; MARGIN: 0cm 0cm 0pt; FONT-FAMILY: 'Times New Roman'; mso-style-parent: ''; mso-pagination: widow-orphan; mso-fareast-font-family: 'Times New Roman'}\r.Stil13 {FONT-SIZE: 9px; COLOR: #808080; FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif; TEXT-DECORATION: none}\r.Stil17 {FONT-WEIGHT: bold; FONT-SIZE: 11px; FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif}\r</STYLE>\r<!--\rStil1 fuer News Quelle Link\rStil2 fuer Newsueberschrift\rStil3 fuer [mehr] Link\rStil4 fuer Newstext/Langtext Produkt\rStil5 fuer Produktbezeichnung\rStil10 fuer Ãœberschriftsbalken\rStil11 fuer Adresse oben\rStil12 fuer Link oben office@\r-->\r<META content='MSHTML 6.00.2900.2149' name=GENERATOR></HEAD><BODY><TABLE cellSpacing=0 cellPadding=0 width='100%' border=0><TBODY><TR><TD><DIV class=Stil13 align=center>Sollten Sie dieses E-Mail nicht ordentlich sehen, klicken Sie <A class=Stil12 href='".$rooturl."/reports/mail/report-".$filedate.".html'>hier</A>, oder kopieren Sie den folgenden Link in Ihren Browser: ".$rooturl."/reports/mail/report-".$filedate.".html <BR>&nbsp;&nbsp; </DIV></TD></TR></TBODY></TABLE><TABLE cellPadding=0 width='100%'><TBODY><TR><TD vAlign=top colSpan=2><CENTER></CENTER></TD></TR><TR><TD><IMG src='".$rooturl."/images/mailserverreport.jpg'></TD><TD class=Stil11 vAlign=top align=right>&nbsp;</TD></TR></TBODY></TABLE><FONT face=arial size=2><BR></FONT>";
			$report.="<B>Inhalt:</B><br><ol><a href='#top20'>Top 20</a><br><a href='#lastblocked'>letzte geblockte Hosts</a><br><a href='#1weekblocked'>nach einw&ouml;chiger Sperre reaktivierte Hosts</a><br><a href='#1monthblocked'>nach einmonatiger Sperre reaktivierte Hosts</a><br><a href='#permanentblocked'>nach wiederholtem Spammen permanent gesperrte Hosts</a><br><a href='#malware'>Malware report (Viren/W&uuml;rmer/Trojaner etc.)</a><br><a href='#spam'>Spam report</a></ol><br>".$top20."<BR>".$lastblocked."<BR>".$checkblocklist."<BR>".$malware."<BR>".$spam."<BR></BODY></HTML>";
			$subject="Spamreport für den ".$date;
			$fp=fopen ($reportdir."report-".$filedate.".html","w");
			if ($fp) {
			    fwrite ($fp,$report);
			    fclose ($fp);
			}
			switch ($row["ContactType"]) {
				case 2:
					SendMail(MAIL_SENDER,MAIL_SENDER_NAME,$row["ContactAddress"],"",$subject,$report);
					break;
				default:
				echo "unknown contact type (".$row['ContactType'].")";
			}
			break;
		default:
			echo "unknown report type (".$type.")";
	} // switch
} // while
?>
